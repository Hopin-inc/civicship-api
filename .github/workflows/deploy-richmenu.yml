name: Deploy Rich Menu

on:
  workflow_dispatch:
    inputs:
      community:
        description: 'Community ID to deploy (neo88, izu, dais, kibotcha, or "all")'
        required: true
        type: choice
        options:
          - neo88
          - izu
          - dais
          - kibotcha
          - all
      environment:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - dev
          - prd
        default: dev

concurrency:
  group: richmenu-${{ github.event.inputs.environment }}-${{ github.event.inputs.community }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    timeout-minutes: 15

    permissions:
      id-token: write
      contents: read

    env:
      STAGE: ${{ github.event.inputs.environment }}
      GCP_REGION: ${{ secrets.GCP_REGION }}
      DB_USER: ${{ secrets.DB_USER }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      DB_NAME: ${{ secrets.DB_NAME }}
      JUMPBOX_INSTANCE_NAME: ${{ secrets.JUMPBOX_INSTANCE_NAME }}
      JUMPBOX_ZONE: ${{ secrets.JUMPBOX_ZONE }}

    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Set up Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Authenticate to Google Cloud (Workload Identity Federation)
        uses: google-github-actions/auth@8254fb75a33b976a221574d287e93919e6a36f70 # v2.1.6
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Set up gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Connect to DB via jumpbox and deploy rich menu
        env:
          DATABASE_URL: postgresql://${{ env.DB_USER }}:${{ env.DB_PASSWORD }}@localhost:5432/${{ env.DB_NAME }}
        run: |
          echo "--- Connecting to DB via jumpbox ---"
          gcloud compute ssh ${{ env.JUMPBOX_INSTANCE_NAME }} \
            --tunnel-through-iap \
            --zone=${{ env.JUMPBOX_ZONE }} \
            --quiet -- -N -L 5432:localhost:5432 &
          SSH_PID=$!

          echo "--- Waiting for database connection ---"
          for i in {1..30}; do
            if pg_isready -h localhost -p 5432 2>/dev/null; then
              echo "Database is ready"
              break
            fi
            echo "Waiting for database connection... ($i/30)"
            sleep 2
          done

          echo "--- Generating Prisma Client ---"
          pnpm db:generate

          echo "--- Deploying Rich Menu ---"
          if [ "${{ github.event.inputs.community }}" = "all" ]; then
            pnpm richmenu:deploy --all
          else
            pnpm richmenu:deploy --community=${{ github.event.inputs.community }}
          fi

          echo "--- Killing SSH tunnel ---"
          kill $SSH_PID || true

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/google_compute_engine ~/.ssh/google_compute_engine.pub
