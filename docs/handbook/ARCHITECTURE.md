# ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‚¬ã‚¤ãƒ‰

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€civicship-api ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã€å®Ÿè£…åŸå‰‡ã«ã¤ã„ã¦èª¬æ˜ã—ã¾ã™ã€‚

## æ¦‚è¦

civicship API ã¯ **ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆï¼ˆDDDï¼‰** ã¨ **ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£** ã®åŸå‰‡ã«å¾“ã„ã€3ã¤ã®ä¸»è¦ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§é–¢å¿ƒäº‹ã‚’æ˜ç¢ºã«åˆ†é›¢ã—ã¦ã„ã¾ã™ã€‚

## ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£åŸå‰‡

### 1. ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆï¼ˆDDDï¼‰
- **ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸­å¿ƒã‚¢ãƒ—ãƒ­ãƒ¼ãƒ:** ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä¸­å¿ƒã¨ã—ãŸãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æ•´ç†
- **å¢ƒç•Œã¥ã‘ã‚‰ã‚ŒãŸã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ:** ç•°ãªã‚‹ãƒ“ã‚¸ãƒã‚¹é ˜åŸŸé–“ã®æ˜ç¢ºãªå¢ƒç•Œ
- **ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹:** ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®æ“ä½œã®ã‚«ãƒ—ã‚»ãƒ«åŒ–

### 2. ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£
- **ä¾å­˜æ€§é€†è»¢:** é«˜ãƒ¬ãƒ™ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ä½ãƒ¬ãƒ™ãƒ«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã«ä¾å­˜ã—ãªã„
- **ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢:** ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£é–“ã®æ˜ç¢ºãªå¢ƒç•Œ
- **ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£:** ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ç‹¬ç«‹æ€§:** å¤–éƒ¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã«ä¾å­˜ã—ãªã„ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯

## ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ (`src/application/`)

**ç›®çš„:** ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³æ“ä½œ

```
application/
â”œâ”€â”€ domain/              # ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
â”‚   â”œâ”€â”€ account/        # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ç®¡ç†ï¼ˆ8ã¤ã®ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
â”‚   â”‚   â”œâ”€â”€ auth/       # èªè¨¼ãƒ»LIFFçµ±åˆ
â”‚   â”‚   â”œâ”€â”€ community/  # ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ä½œæˆã€ç®¡ç†ã€è¨­å®š
â”‚   â”‚   â”œâ”€â”€ identity/   # ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ èªè¨¼ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ membership/ # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£é–¢ä¿‚ã€ãƒ­ãƒ¼ãƒ«ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ nft-wallet/ # NFTã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ©Ÿèƒ½
â”‚   â”‚   â”œâ”€â”€ user/       # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã€èªè¨¼
â”‚   â”‚   â””â”€â”€ wallet/     # ãƒã‚¤ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”œâ”€â”€ experience/     # æ©Ÿä¼šãƒ»å‚åŠ ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ opportunity/    # ã‚¤ãƒ™ãƒ³ãƒˆãƒ»æ´»å‹•ä½œæˆ
â”‚   â”‚   â”œâ”€â”€ reservation/    # äºˆç´„ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”‚   â”œâ”€â”€ participation/  # å‡ºå¸­è¿½è·¡
â”‚   â”‚   â””â”€â”€ evaluation/     # å‚åŠ å¾Œè©•ä¾¡
â”‚   â”œâ”€â”€ content/        # ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ article/    # ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£è¨˜äº‹
â”‚   â”‚   â””â”€â”€ image/      # ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãƒ»ä¿å­˜
â”‚   â”œâ”€â”€ reward/         # ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ã‚·ã‚¹ãƒ†ãƒ 
â”‚   â”‚   â”œâ”€â”€ utility/    # äº¤æ›å¯èƒ½ãªç‰¹å…¸
â”‚   â”‚   â””â”€â”€ ticket/     # ãƒã‚¤ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ãƒã‚±ãƒƒãƒˆ
â”‚   â”œâ”€â”€ transaction/    # ãƒã‚¤ãƒ³ãƒˆè»¢é€
â”‚   â”œâ”€â”€ notification/   # é€šçŸ¥
â”‚   â””â”€â”€ location/       # åœ°ç†æƒ…å ±
â”œâ”€â”€ provider.ts         # ä¾å­˜æ€§æ³¨å…¥
â””â”€â”€ utils.ts           # å…±æœ‰é–¢æ•°
```

**ä¸»è¦ç‰¹å¾´:**
- ç´”ç²‹ãªãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’å«ã‚€
- å¤–éƒ¨ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‹ã‚‰ç‹¬ç«‹
- ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©
- ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ã¨ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’å®Ÿè£…

### 2. ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤ (`src/infrastructure/`)

**ç›®çš„:** å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã¨ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–

```
infrastructure/
â”œâ”€â”€ prisma/             # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å±¤
â”‚   â”œâ”€â”€ schema.prisma  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â”œâ”€â”€ migrations/    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
â”‚   â”œâ”€â”€ seeds/         # åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥
â”‚   â”‚   â”œâ”€â”€ index.ts   # ã‚·ãƒ¼ãƒ‰å‡¦ç†ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”‚   â”œâ”€â”€ master.ts  # ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆéƒ½å¸‚ã€å·ï¼‰
â”‚   â”‚   â””â”€â”€ domain.ts  # ãƒ“ã‚¸ãƒã‚¹ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ï¼‰
â”‚   â”œâ”€â”€ factories/     # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
â”‚   â””â”€â”€ client.ts      # Prismaã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
â””â”€â”€ libs/              # å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹çµ±åˆ
    â”œâ”€â”€ firebase.ts    # Firebaseèªè¨¼
    â”œâ”€â”€ storage.ts     # Google Cloud Storage
    â””â”€â”€ did.ts         # åˆ†æ•£IDï¼ˆIDENTUSï¼‰
```

**ä¸»è¦ç‰¹å¾´:**
- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å±¤ã§å®šç¾©ã•ã‚ŒãŸã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®Ÿè£…
- å¤–éƒ¨APIçµ±åˆã‚’å‡¦ç†
- ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ã¨å–å¾—ã‚’ç®¡ç†
- ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯å›ºæœ‰ã®ã‚³ãƒ¼ãƒ‰ã‚’å«ã‚€

### 3. ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ (`src/presentation/`)

**ç›®çš„:** APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ»ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†

```
presentation/
â”œâ”€â”€ graphql/          
â”‚   â”œâ”€â”€ schema/       # GraphQLã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â”‚   â”œâ”€â”€ resolver/     # ã‚¯ã‚¨ãƒªãƒ»ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒªã‚¾ãƒ«ãƒãƒ¼
â”‚   â”œâ”€â”€ dataloader/   # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
â”‚   â”œâ”€â”€ rule.ts       # èªå¯ãƒ«ãƒ¼ãƒ«
â”‚   â””â”€â”€ server.ts     # Apollo Serverè¨­å®š
â”œâ”€â”€ middleware/       
â”‚   â”œâ”€â”€ auth.ts      # èªè¨¼ãƒ»ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
â”‚   â”œâ”€â”€ cors.ts      # ã‚¯ãƒ­ã‚¹ã‚ªãƒªã‚¸ãƒ³ãƒªã‚½ãƒ¼ã‚¹å…±æœ‰
â”‚   â””â”€â”€ logger.ts    # ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ­ã‚°
â””â”€â”€ router/          # RESTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
    â””â”€â”€ line.ts  # LINE Webhook
```

**ä¸»è¦ç‰¹å¾´:**
- HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å‡¦ç†
- GraphQLãƒªã‚¾ãƒ«ãƒãƒ¼ã‚’å®Ÿè£…
- èªè¨¼ã¨èªå¯ã‚’ç®¡ç†
- Webhookç”¨RESTã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’æä¾›

## ãƒ‰ãƒ¡ã‚¤ãƒ³æ§‹é€ ãƒ‘ã‚¿ãƒ¼ãƒ³

å„ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ä¿å®ˆæ€§ã¨ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã‚’ä¿ƒé€²ã™ã‚‹ä¸€è²«ã—ãŸãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ ã«å¾“ã„ã¾ã™ï¼š

```
domain/
â”œâ”€â”€ controller/
â”‚   â”œâ”€â”€ resolver.ts      # GraphQL APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
â”‚   â””â”€â”€ dataloader.ts    # åŠ¹ç‡çš„ãªãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆN+1å•é¡Œé˜²æ­¢ï¼‰
â”œâ”€â”€ usecase.ts          # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
â”œâ”€â”€ service.ts          # ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³æ“ä½œ
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ repository.ts   # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å®Ÿè£…
â”‚   â”œâ”€â”€ interface.ts    # ãƒªãƒã‚¸ãƒˆãƒªå¥‘ç´„
â”‚   â”œâ”€â”€ converter.ts    # GraphQL â†” Prisma ãƒ‡ãƒ¼ã‚¿å¤‰æ›
â”‚   â””â”€â”€ type.ts         # ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰å‹
â”œâ”€â”€ schema/             # GraphQLã‚¹ã‚­ãƒ¼ãƒå®šç¾©
â””â”€â”€ presenter.ts        # ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ•´å½¢
```

### ãƒ¬ã‚¤ãƒ¤ãƒ¼è²¬å‹™

#### ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼å±¤
- **resolver.ts:** GraphQLã‚¯ã‚¨ãƒªãƒ»ãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
- **dataloader.ts:** ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãŸã‚ã®ãƒãƒƒãƒãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿

#### ãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹å±¤
- **usecase.ts:** ãƒ“ã‚¸ãƒã‚¹æ“ä½œã®ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- ã‚µãƒ¼ãƒ“ã‚¹ã¨ãƒªãƒã‚¸ãƒˆãƒªé–“ã®èª¿æ•´
- èªå¯ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®ç®¡ç†

#### ã‚µãƒ¼ãƒ“ã‚¹å±¤
- **service.ts:** ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«ã¨æ¤œè¨¼ã®å®Ÿè£…
- è¤‡é›‘ãªãƒ“ã‚¸ãƒã‚¹æ“ä½œã®å‡¦ç†
- ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹é–¢å¿ƒäº‹ã‹ã‚‰ç‹¬ç«‹

#### ãƒ‡ãƒ¼ã‚¿å±¤
- **repository.ts:** ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å®Ÿè£…
- **interface.ts:** ãƒªãƒã‚¸ãƒˆãƒªå¥‘ç´„ï¼ˆä¾å­˜æ€§é€†è»¢ï¼‰
- **converter.ts:** ãƒ¬ã‚¤ãƒ¤ãƒ¼é–“ã®ãƒ‡ãƒ¼ã‚¿å¤‰æ›
- **type.ts:** ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰å‹å®šç¾©

## ä¸»è¦ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ‘ã‚¿ãƒ¼ãƒ³

### 1. DataLoaderãƒ‘ã‚¿ãƒ¼ãƒ³

**ç›®çš„:** GraphQLã§ã®N+1ã‚¯ã‚¨ãƒªå•é¡Œã®é˜²æ­¢
**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:** `dataloader@2.2.3`

**å®Ÿè£…ä¾‹:**
```typescript
// å®Ÿéš›ã®å®Ÿè£…: src/application/domain/account/user/controller/dataloader.ts
export const createUserDataLoader = (issuer: PrismaClientIssuer) => {
  return new DataLoader<string, PrismaUser | null>(
    async (userIds: readonly string[]) => {
      const users = await issuer.internal((tx) =>
        tx.user.findMany({
          where: { id: { in: [...userIds] } },
        }),
      );
      return userIds.map(id => users.find(user => user.id === id) || null);
    },
  );
};

// ã‚¦ã‚©ãƒ¬ãƒƒãƒˆç”¨DataLoaderå®Ÿè£…
export const createMemberWalletDataLoader = (issuer: PrismaClientIssuer) => {
  return new DataLoader<string, PrismaWallet | null>(
    async (userIds: readonly string[]) => {
      return issuer.internal((tx) =>
        tx.wallet.findMany({
          where: { userId: { in: [...userIds] } },
          include: { currentPointView: true },
        }),
      );
    },
  );
};
```

**åˆ©ç‚¹:**
- è¤‡æ•°ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ã‚¨ãƒªã‚’å˜ä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ãƒãƒƒãƒå‡¦ç†
- å˜ä¸€ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å†…ã§ã®çµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥
- GraphQLã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®å¤§å¹…æ”¹å–„

### 2. ä¾å­˜æ€§æ³¨å…¥ï¼ˆtsyringeï¼‰

**ç›®çš„:** ã‚¯ãƒªãƒ¼ãƒ³ãªä¾å­˜é–¢ä¿‚ç®¡ç†ã¨ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£
**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:** `tsyringe@4.10.0`
**è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«:** `src/application/provider.ts`ï¼ˆ275è¡Œã®åŒ…æ‹¬çš„DIè¨­å®šï¼‰

**å®Ÿè£…:**
```typescript
// å®Ÿéš›ã®DIè¨­å®š: src/application/provider.ts
export function registerProductionDependencies() {
  // ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£
  container.register("prismaClient", { useValue: prismaClient });
  container.register("PrismaClientIssuer", { useClass: PrismaClientIssuer });
  
  // å…¨7ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ã‚µãƒ¼ãƒ“ã‚¹ãƒ»ãƒªãƒã‚¸ãƒˆãƒªç™»éŒ²
  // Account Domain
  container.register("UserService", { useClass: UserService });
  container.register("UserRepository", { useClass: UserRepository });
  container.register("CommunityService", { useClass: CommunityService });
  container.register("CommunityRepository", { useClass: CommunityRepository });
  // ... ä»–ã®ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚‚åŒæ§˜ã«ç™»éŒ²
}

// ã‚µãƒ¼ãƒ“ã‚¹å®Ÿè£…ä¾‹
@injectable()
export class UserService {
  constructor(
    @inject("UserRepository") private userRepo: IUserRepository,
    @inject("PrismaClientIssuer") private issuer: PrismaClientIssuer
  ) {}
}
```

**åˆ©ç‚¹:**
- ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®ç–çµåˆ
- ãƒ†ã‚¹ãƒˆç”¨ã®ä¾å­˜é–¢ä¿‚ãƒ¢ãƒƒã‚¯ãŒå®¹æ˜“
- é›†ä¸­åŒ–ã•ã‚ŒãŸä¾å­˜é–¢ä¿‚è¨­å®š
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã®ã‚µãƒãƒ¼ãƒˆ

### 3. RLSï¼ˆPrismaClientIssuerï¼‰

**ç›®çš„:** ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¨©é™ã«åŸºã¥ããƒ‡ãƒ¼ã‚¿åˆ†é›¢
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:** `src/infrastructure/prisma/client.ts`

**å®Ÿè£…:**
```typescript
// å®Ÿéš›ã®RLSå®Ÿè£…
export class PrismaClientIssuer {
  public async onlyBelongingCommunity<T>(ctx: IContext, callback: CallbackFn<T>): Promise<T> {
    if (ctx.isAdmin) {
      return this.public(ctx, callback);
    }
    
    const user = ctx.currentUser;
    if (user) {
      return await this.client.$transaction(async (tx) => {
        await this.setRls(tx);
        await this.setRlsConfigUserId(tx, user.id);
        return await callback(tx);
      });
    }
    throw new AuthorizationError("Not authenticated");
  }
  
  private async setRlsConfigUserId(tx: Transaction, userId: string | null) {
    const [{ value }] = await tx.$queryRawUnsafe<[{ value: string }]>(
      `SELECT set_config('app.rls_config.user_id', '${userId ?? ""}', FALSE) as value;`,
    );
    return value;
  }

  // ç®¡ç†è€…ç”¨ãƒã‚¤ãƒ‘ã‚¹
  public async admin<T>(ctx: IContext, callback: CallbackFn<T>): Promise<T> {
    return await this.client.$transaction(async (tx) => {
      await this.setRlsBypass(tx, true);
      return await callback(tx);
    });
  }
}

// ä½¿ç”¨ä¾‹: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ãè‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const issuer = new PrismaClientIssuer();
const communities = await issuer.onlyBelongingCommunity((tx) => 
  tx.community.findMany()
); // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ã‚»ã‚¹ã§è‡ªå‹•ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
```

**åˆ©ç‚¹:**
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ãè‡ªå‹•ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ã®é˜²æ­¢
- èªå¯ãƒ­ã‚¸ãƒƒã‚¯ã®ç°¡ç´ åŒ–
- å…¨ã‚¯ã‚¨ãƒªã§ã®ä¸€è²«ã—ãŸã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 4. èªå¯ãƒ«ãƒ¼ãƒ«

**ç›®çš„:** GraphQLãƒ¬ãƒ™ãƒ«ã§ã®æ¨©é™ãƒã‚§ãƒƒã‚¯
**ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸:** `@graphql-authz/core@1.3.2`
**å®Ÿè£…ãƒ•ã‚¡ã‚¤ãƒ«:** `src/presentation/graphql/rule.ts`

**å®Ÿè£…:**
```typescript
// å®Ÿéš›ã®èªå¯ãƒ«ãƒ¼ãƒ«å®Ÿè£…
const IsUser = preExecRule({
  error: new AuthenticationError("User must be logged in"),
})((context: IContext) => {
  if (context.isAdmin) return true;
  return !!context.currentUser;
});

const IsCommunityOwner = preExecRule({
  error: new AuthorizationError("User must be community owner"),
})((context: IContext, args: { permission?: { communityId?: string } }) => {
  if (context.isAdmin) return true;
  
  const user = context.currentUser;
  const permission = args.permission;
  
  if (!user || !permission?.communityId) return false;
  
  const membership = context.hasPermissions?.memberships?.find(
    (m) => m.communityId === permission.communityId,
  );
  
  return membership?.role === Role.OWNER;
});

// åˆ©ç”¨å¯èƒ½ãªèªå¯ãƒ«ãƒ¼ãƒ«
export const rules = {
  IsUser,                 // ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼
  IsAdmin,                // ã‚·ã‚¹ãƒ†ãƒ ç®¡ç†è€…
  IsSelf,                 // è‡ªåˆ†è‡ªèº«ã®æ“ä½œ
  IsCommunityOwner,       // ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚ªãƒ¼ãƒŠãƒ¼
  IsCommunityManager,     // ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼
  IsCommunityMember,      // ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ¡ãƒ³ãƒãƒ¼
  IsOpportunityOwner,     // æ©Ÿä¼šä½œæˆè€…
  CanReadPhoneNumber,     // é›»è©±ç•ªå·èª­ã¿å–ã‚Šæ¨©é™
} as const;
```

**åˆ©ç‚¹:**
- å®£è¨€çš„èªå¯ãƒ«ãƒ¼ãƒ«
- çµ„ã¿åˆã‚ã›å¯èƒ½ãªæ¨©é™ãƒã‚§ãƒƒã‚¯
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Šã®ãŸã‚ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- é–¢å¿ƒäº‹ã®æ˜ç¢ºãªåˆ†é›¢

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ã‚¹ã‚­ãƒ¼ãƒæ§‹æˆ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒã¯ã‚³ã‚¢ãƒ“ã‚¸ãƒã‚¹ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä¸­å¿ƒã«æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ï¼š

#### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†
- **Users:** å€‹äººãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨èªè¨¼
- **Communities:** æ©Ÿä¼šã‚’ãƒ›ã‚¹ãƒˆã™ã‚‹çµ„ç¹”
- **Memberships:** ãƒ­ãƒ¼ãƒ«ä»˜ããƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ»ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£é–¢ä¿‚ï¼ˆOWNERã€MANAGERã€MEMBERï¼‰
- **Identities:** ãƒãƒ«ãƒãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ èªè¨¼ï¼ˆLINEã€Firebaseã€é›»è©±ï¼‰
- **Wallets:** ãƒã‚¤ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆCOMMUNITYã€MEMBERï¼‰
- **NFT Wallets:** NFTæ©Ÿèƒ½çµ±åˆ

#### ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ 
- **Opportunities:** ã‚¤ãƒ™ãƒ³ãƒˆã€æ´»å‹•ã€ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢å‹Ÿé›†
- **OpportunitySlots:** é–‹å‚¬æ 
- **Reservations:** å‹Ÿé›†é–‹å‚¬æ ã®äºˆç´„
- **Participations:** å®Ÿéš›ã®æ´»å‹•

#### å ±é…¬ã‚·ã‚¹ãƒ†ãƒ 
- **Transactions:** ã‚¦ã‚©ãƒ¬ãƒƒãƒˆé–“ã®ãƒã‚¤ãƒ³ãƒˆè»¢é€
- **Utilities:** ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãŒæä¾›ã™ã‚‹äº¤æ›å¯èƒ½ãªç‰¹å…¸
- **Tickets:** ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£äº¤æ›ç”¨ãƒã‚¤ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ãƒã‚±ãƒƒãƒˆ

#### ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç®¡ç†
- **Articles:** ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å…¬é–‹ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
- **Images:** GCSçµ±åˆãƒ¡ãƒ‡ã‚£ã‚¢ãƒ•ã‚¡ã‚¤ãƒ«
- **Places:** å‹Ÿé›†ã®åœ°ç†çš„ä½ç½®

#### åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ 
- **Community Configs:** LINEãƒãƒ£ãƒ³ãƒãƒ«ã¨LIFFè¨­å®š

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

#### ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ã¨ãƒ“ãƒ¥ãƒ¼
**å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ãƒ“ãƒ¥ãƒ¼ï¼ˆPrismaã‚¹ã‚­ãƒ¼ãƒã§å®šç¾©ï¼‰:**

**ãƒã‚¤ãƒ³ãƒˆé–¢é€£ãƒ“ãƒ¥ãƒ¼:**
- `CurrentPointView` (`mv_current_points`) - ç¾åœ¨ã®ãƒã‚¤ãƒ³ãƒˆæ®‹é«˜
- `AccumulatedPointView` (`mv_accumulated_points`) - ç´¯ç©ãƒã‚¤ãƒ³ãƒˆåˆè¨ˆ

**å ´æ‰€é–¢é€£ãƒ“ãƒ¥ãƒ¼:**
- `PlacePublicOpportunityCountView` - å ´æ‰€åˆ¥å…¬é–‹æ©Ÿä¼šæ•°
- `PlaceAccumulatedParticipantsView` - å ´æ‰€åˆ¥ç´¯ç©å‚åŠ è€…æ•°

**ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—é–¢é€£ãƒ“ãƒ¥ãƒ¼:**
- `MembershipParticipationGeoView` - ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—å‚åŠ åœ°ç†æƒ…å ±
- `MembershipParticipationCountView` - ãƒ¡ãƒ³ãƒãƒ¼ã‚·ãƒƒãƒ—å‚åŠ æ•°çµ±è¨ˆ
- `MembershipHostedOpportunityCountView` - ãƒ›ã‚¹ãƒˆæ©Ÿä¼šæ•°çµ±è¨ˆ

**æ©Ÿä¼šé–¢é€£ãƒ“ãƒ¥ãƒ¼:**
- `EarliestReservableSlotView` - æœ€æ—©äºˆç´„å¯èƒ½ã‚¹ãƒ­ãƒƒãƒˆ
- `OpportunityAccumulatedParticipantsView` - æ©Ÿä¼šåˆ¥ç´¯ç©å‚åŠ è€…æ•°
- `SlotRemainingCapacityView` - ã‚¹ãƒ­ãƒƒãƒˆæ®‹å®¹é‡è¨ˆç®—

```sql
-- ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼ã®ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
-- src/infrastructure/prisma/sql/refreshMaterializedViewCurrentPoints.sql
REFRESH MATERIALIZED VIEW CONCURRENTLY "mv_current_points";
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- ä¸€èˆ¬çš„ãªã‚¯ã‚¨ãƒªãƒ‘ã‚¿ãƒ¼ãƒ³ã«æœ€é©åŒ–
- è¤‡é›‘ãªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ç”¨ã®è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- æ¡ä»¶ä»˜ãã‚¯ã‚¨ãƒªç”¨ã®éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- çµåˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ã®å¤–éƒ¨ã‚­ãƒ¼ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹

#### ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒªãƒ³ã‚°
- Prismaã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
- ç’°å¢ƒã«åŸºã¥ãè¨­å®šå¯èƒ½ãªãƒ—ãƒ¼ãƒ«ã‚µã‚¤ã‚º
- ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ç›£è¦–

### ã‚¯ã‚¨ãƒªæœ€é©åŒ–

#### DataLoaderãƒ‘ã‚¿ãƒ¼ãƒ³å®Ÿè£…
- N+1ã‚¯ã‚¨ãƒªã‚’å˜ä¸€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‘¼ã³å‡ºã—ã«ãƒãƒƒãƒå‡¦ç†
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¯ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è² è·ã®å¤§å¹…å‰Šæ¸›

#### åŠ¹ç‡çš„ãªãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
```typescript
// å¤§è¦æ¨¡ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆç”¨ã®ã‚«ãƒ¼ã‚½ãƒ«ãƒ™ãƒ¼ã‚¹ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³
const opportunities = await prisma.opportunity.findMany({
  take: limit,
  skip: cursor ? 1 : 0,
  cursor: cursor ? { id: cursor } : undefined,
  orderBy: { createdAt: 'desc' }
});
```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### èªè¨¼ãƒ•ãƒ­ãƒ¼

1. **ãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼** â†’ `presentation/middleware/auth.ts`
   - Firebase JWTãƒˆãƒ¼ã‚¯ãƒ³æ¤œè¨¼
   - ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å‘ã‘ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆã‚µãƒãƒ¼ãƒˆ
   - ãƒˆãƒ¼ã‚¯ãƒ³æœ‰åŠ¹æœŸé™ã¨æ›´æ–°å‡¦ç†

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ** â†’ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œç´¢
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã¨æ¨©é™ã®èª­ã¿è¾¼ã¿
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
   - ãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼ã®åˆæœŸåŒ–

3. **æ¨©é™å‰²ã‚Šå½“ã¦** â†’ ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹æ¨©é™
   - ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å›ºæœ‰ã®ãƒ­ãƒ¼ãƒ«å‰²ã‚Šå½“ã¦
   - ã‚·ã‚¹ãƒ†ãƒ ãƒ¬ãƒ™ãƒ«ç®¡ç†è€…æ¨©é™
   - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå¯¾å¿œæ¨©é™ãƒã‚§ãƒƒã‚¯

4. **ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ** â†’ ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«å…¨ä½“ã§åˆ©ç”¨å¯èƒ½
   - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±
   - æ¨©é™ãƒ•ãƒ©ã‚°
   - RLSç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç™ºè¡Œè€…
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ­ãƒ¼ãƒ€ãƒ¼

### èªå¯ãƒ¬ã‚¤ãƒ¤ãƒ¼

#### 1. GraphQLãƒ«ãƒ¼ãƒ«ï¼ˆå®Ÿè¡Œå‰ãƒ»å®Ÿè¡Œå¾Œï¼‰
```typescript
// å®Ÿè¡Œå‰æ¨©é™ãƒã‚§ãƒƒã‚¯
export const permissions = shield({
  Query: {
    communities: IsUser,
    adminUsers: IsSystemAdmin,
  },
  Mutation: {
    createCommunity: IsUser,
    updateCommunity: IsCommunityOwner,
  }
});
```

#### 2. RLSï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«ï¼‰
```typescript
// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«åŸºã¥ãè‡ªå‹•ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const issuer = new PrismaClientIssuer(context.currentUser);
const communities = await issuer.onlyBelongingCommunity.community.findMany(); // ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ã¿
```

#### 3. ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ï¼‰
```typescript
// ãƒ‰ãƒ¡ã‚¤ãƒ³å›ºæœ‰ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡
export class CommunityService {
  async updateCommunity(id: string, data: UpdateCommunityInput) {
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã“ã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã‚’æ›´æ–°ã™ã‚‹æ¨©é™ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    await this.validateUpdatePermission(id);
    return this.repository.update(id, data);
  }
}
```

#### 4. APIã‚­ãƒ¼èªè¨¼ï¼ˆç®¡ç†è€…ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼‰
```typescript
// ç®¡ç†è€…ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä¿è­·
export const adminAuth = (req: Request, res: Response, next: NextFunction) => {
  const apiKey = req.headers['x-api-key'];
  if (apiKey !== process.env.CIVICSHIP_ADMIN_API_KEY) {
    return res.status(401).json({ error: 'Unauthorized' });
  }
  next();
};
```

## ãƒ†ã‚¹ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### ãƒ†ã‚¹ãƒˆæ§‹æˆ

```
__tests__/
â”œâ”€â”€ unit/              # å€‹åˆ¥é–¢æ•°ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ services/     # ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ repositories/ # ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ utils/        # ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ integration/       # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹çµ±åˆãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ graphql/      # GraphQLãƒªã‚¾ãƒ«ãƒãƒ¼ãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ auth/         # èªè¨¼ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ database/     # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ“ä½œãƒ†ã‚¹ãƒˆ
â”œâ”€â”€ e2e/              # ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰APIãƒ†ã‚¹ãƒˆ
â”‚   â”œâ”€â”€ user-flows/   # å®Œå…¨ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¸ãƒ£ãƒ¼ãƒ‹ãƒ¼ãƒ†ã‚¹ãƒˆ
â”‚   â””â”€â”€ admin-flows/  # ç®¡ç†è€…æ“ä½œãƒ†ã‚¹ãƒˆ
â””â”€â”€ fixtures/         # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    â”œâ”€â”€ factories/    # ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    â””â”€â”€ helpers/      # ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
```

### ãƒ†ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³

#### ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼‰
```typescript
// ä¾‹: ä¸€è²«ã—ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼
export const createUser = (overrides?: Partial<User>): User => ({
  id: faker.datatype.uuid(),
  name: faker.name.fullName(),
  email: faker.internet.email(),
  createdAt: new Date(),
  ...overrides
});
```

#### ãƒªãƒã‚¸ãƒˆãƒªãƒ¢ãƒƒã‚¯ï¼ˆãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆåˆ†é›¢ï¼‰
```typescript
// ä¾‹: ã‚µãƒ¼ãƒ“ã‚¹ãƒ†ã‚¹ãƒˆç”¨ãƒ¢ãƒƒã‚¯ãƒªãƒã‚¸ãƒˆãƒª
const mockUserRepository = {
  findById: jest.fn(),
  create: jest.fn(),
  update: jest.fn(),
  delete: jest.fn()
};
```

#### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ï¼‰
```typescript
// ä¾‹: è‡ªå‹•ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
beforeEach(async () => {
  await prisma.$transaction(async (tx) => {
    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
  });
});

afterEach(async () => {
  await prisma.$transaction(async (tx) => {
    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
  });
});
```

#### GraphQLãƒ†ã‚¹ãƒˆï¼ˆã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰APIæ¤œè¨¼ï¼‰
```typescript
// ä¾‹: GraphQLãƒŸãƒ¥ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
const CREATE_COMMUNITY = gql`
  mutation CreateCommunity($input: CreateCommunityInput!) {
    createCommunity(input: $input) {
      id
      name
      pointName
    }
  }
`;

test('should create community', async () => {
  const result = await client.mutate({
    mutation: CREATE_COMMUNITY,
    variables: { input: { name: 'Test Community' } }
  });
  expect(result.data.createCommunity).toBeDefined();
});
```

## ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

civicship-apiã¯ã€Google Cloud Runã‚’ä½¿ç”¨ã—ãŸãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆã§ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã™ï¼š

### ä¸»è¦ã‚µãƒ¼ãƒ“ã‚¹

1. **å†…éƒ¨API** - ãƒ¡ã‚¤ãƒ³GraphQL APIã‚µãƒ¼ãƒãƒ¼ (`src/index.ts`)
2. **å¤–éƒ¨API** - ãƒ‘ãƒ–ãƒªãƒƒã‚¯ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ“ä½œ (`src/external-api.ts`)  
3. **ãƒãƒƒãƒå‡¦ç†** - ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚¸ãƒ§ãƒ– (`src/batch.ts`)

### ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

- **Google Cloud Run** - è‡ªå‹•ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°å¯¾å¿œ
- **Artifact Registry** - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ç®¡ç†
- **GitHub Actions** - CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
- **PostgreSQL** - SSHãƒˆãƒ³ãƒãƒ«çµŒç”±ã®ã‚»ã‚­ãƒ¥ã‚¢ã‚¢ã‚¯ã‚»ã‚¹

è©³ç´°ãªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­å®šã«ã¤ã„ã¦ã¯ã€[ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰](DEPLOYMENT.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ä¸»è¦æœ€é©åŒ–æˆ¦ç•¥

- **DataLoaderãƒ‘ã‚¿ãƒ¼ãƒ³** - N+1ã‚¯ã‚¨ãƒªå•é¡Œã®è§£æ±º
- **ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚ºãƒ‰ãƒ“ãƒ¥ãƒ¼** - è¤‡é›‘ãªé›†è¨ˆã®äº‹å‰è¨ˆç®—
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹** - ã‚¯ã‚¨ãƒªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- **å¤šå±¤ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥** - ãƒªã‚¯ã‚¨ã‚¹ãƒˆã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¬ãƒ™ãƒ«

è©³ç´°ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã«ã¤ã„ã¦ã¯ã€[ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¬ã‚¤ãƒ‰](PERFORMANCE.md) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ãƒ»è¨­è¨ˆ
- **[ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£ã‚¬ã‚¤ãƒ‰](INFRASTRUCTURE.md)** - å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
- **[ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¬ã‚¤ãƒ‰](SECURITY.md)** - èªè¨¼ãƒ»èªå¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€4å±¤ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
- **[ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚¬ã‚¤ãƒ‰](DEPLOYMENT.md)** - ãƒãƒ«ãƒã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆã€CI/CD
- **[ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚¬ã‚¤ãƒ‰](PERFORMANCE.md)** - æœ€é©åŒ–æˆ¦ç•¥ã€ç›£è¦–ãƒ»å¯è¦³æ¸¬æ€§

### ğŸ“š é–‹ç™ºãƒ»å®Ÿè£…
- **[é–‹ç™ºãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼](DEVELOPMENT.md)** - æ—¥å¸¸é–‹ç™ºæ‰‹é †
- **[å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³](PATTERNS.md)** - ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- **[ãƒ†ã‚¹ãƒˆã‚¬ã‚¤ãƒ‰](TESTING.md)** - ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¨å®Ÿè¡Œ

### ğŸ”§ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ»é‹ç”¨
- **[ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰](SETUP.md)** - é–‹ç™ºç’°å¢ƒã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- **[ç’°å¢ƒå¤‰æ•°ã‚¬ã‚¤ãƒ‰](ENVIRONMENT.md)** - ç’°å¢ƒè¨­å®š
- **[ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](TROUBLESHOOTING.md)** - å•é¡Œè§£æ±ºã‚¬ã‚¤ãƒ‰

### ğŸ“‹ ä»•æ§˜ãƒ»è¨­è¨ˆ
- **[æ©Ÿèƒ½ä¸€è¦§](FEATURES.md)** - ãƒ“ã‚¸ãƒã‚¹æ©Ÿèƒ½ã®è©³ç´°
- **[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](../ERD.md)** - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£é–¢ä¿‚å›³
- **[ã‚³ãƒãƒ³ãƒ‰ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹](COMMANDS.md)** - å…¨ã‚³ãƒãƒ³ãƒ‰ä¸€è¦§
