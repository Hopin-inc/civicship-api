# SignUp DID統合テスト

## 概要
ユーザーアカウント作成プロセス中のDID発行テストで、外部API障害がユーザー登録をブロックしないことを確認します。

**テストファイル**: `src/__tests__/integration/signUp/signUp.test.ts`  
**総テストケース数**: 5

## テストケース

### 1. 標準的なユーザー作成とDID発行
**テスト名**: `"should create user, join community, and create wallet successfully"`

- **目的**: 正常パスシナリオでのユーザー作成とDID発行の成功を検証
- **モック設定**: `mockDIDVCClient.call.mockResolvedValue({ jobId: "test-job-id" })`
- **テストフロー**:
  1. コミュニティメンバーシップ付きユーザーアカウント作成
  2. DID発行リクエストのトリガー
  3. ユーザー作成、コミュニティ参加、ウォレット作成の検証
- **期待される動作**: 
  - ユーザーが正常に作成され、コミュニティに参加
  - 適切な初期状態でウォレットが作成される
  - 外部APIでDID発行リクエストが開始される
- **データベース検証**:
  - 正しいメンバーシップステータスでユーザーレコードが存在
  - 適切なタイプとコミュニティ関連付けでウォレットが作成
  - DIDリクエストステータスが成功したAPI相互作用を反映

### 2. 外部API障害ハンドリング
**テスト名**: `"should create user successfully even when DID external API fails"`

- **目的**: DID外部APIが完全に失敗してもユーザー作成が成功することを確認
- **モック設定**: `mockDIDVCClient.call.mockResolvedValue(null)`
- **テストフロー**:
  1. 外部DID APIがnull（失敗）を返すシミュレーション
  2. ユーザー作成プロセスの実行
  3. ユーザー作成が正常に完了することを検証
  4. DIDリクエストが適切なエラー状態でマークされることを確認
- **期待される動作**: 
  - ユーザー作成が中断されることなく完了
  - コミュニティメンバーシップが正常に確立
  - ウォレット作成が正常に進行
  - DIDリクエストが失敗としてマークされるが、メインフローをブロックしない
- **データベース状態検証**:
  - `status`: "PENDING"
  - `errorMessage`: "External API call failed"
  - `retryCount`: 1
  - `jobId`: null
  - `processedAt`: null

### 3. APIタイムアウトハンドリング
**テスト名**: `"should create user successfully when DID external API times out"`

- **目的**: ユーザー作成をブロックすることなく外部APIタイムアウトの適切な処理をテスト
- **モック設定**: 
  ```typescript
  mockDIDVCClient.call.mockImplementation(() => {
    return new Promise((resolve) => {
      setTimeout(() => resolve(null), 100);
    });
  });
  ```
- **テストフロー**:
  1. 100ms遅延でnullを返すAPI呼び出しをシミュレーション
  2. タイムアウトシナリオでユーザー作成を実行
  3. ノンブロッキングタイムアウト動作を検証
- **期待される動作**: 
  - APIタイムアウトにもかかわらずユーザー作成が完了
  - タイムアウトが失敗として扱われ、API失敗と同じエラーハンドリング
  - メインユーザー作成フローのハングやブロックなし
- **データベース状態**: 外部API失敗と同じ（PENDINGステータスとエラーメッセージ）

### 4. Firebase トークンリフレッシュ失敗
**テスト名**: `"should handle Firebase token refresh failure gracefully"`

- **目的**: Firebase認証失敗がユーザー作成プロセスをブロックしないことを検証
- **モック設定**: `mockDIDVCClient.call.mockResolvedValue({ jobId: "test-job-id" })` (DID APIは成功)
- **テストシナリオ**: 認証プロセス中にFirebaseトークンリフレッシュが失敗
- **期待される動作**: 
  - Firebase認証問題にもかかわらずユーザー作成が成功
  - 利用可能な認証でDID処理が継続
  - システムが認証サービス失敗を適切に処理
- **データベース検証**:
  - ユーザーが正常に作成される
  - DIDリクエストが成功した処理ステータスを示す
  - 認証失敗がメインフローをブロックするために伝播しない

### 5. 複数の同時外部API失敗
**テスト名**: `"should handle multiple external API failures simultaneously"`

- **目的**: 複数の外部サービス失敗下でのシステム回復力をテスト
- **モック設定**: `mockDIDVCClient.call.mockResolvedValue(null)` (すべての外部APIが失敗)
- **テストシナリオ**: 複数の外部サービス（DID API、潜在的にFirebaseなど）が同時に失敗
- **期待される動作**: 
  - コアユーザー作成フローが完全に影響を受けない
  - すべての外部サービス失敗が適切に処理される
  - ユーザー登録が正常に完了
  - 複数の失敗状態が適切に記録される
- **データベース状態**: 
  - ユーザー作成成功
  - DIDリクエストがエラー状態でPENDINGとしてマーク
  - システムがカスケード外部失敗に対する回復力を実証

## テストセットアップ要件

### 前提条件
- タイムスタンプとランダム文字列を使用したユニークテストデータ生成
- 必要な設定での適切なコミュニティセットアップ
- 適切に設定されたモックDID/VCサーバークライアント
- テストデータベースの分離とクリーンアップ

### 主要テストデータパターン
```typescript
const uniqueId = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
const community = await TestDataSourceHelper.createCommunity({
  name: `test-community-${uniqueId}`,
  // ... その他のプロパティ
});
```

### モック設定
```typescript
mockDIDVCClient = { call: jest.fn() } as any;
container.register("DIDVCServerClient", { useValue: mockDIDVCClient });
```

## 検証パターン

### ユーザー作成検証
- 正しいプロパティでユーザーレコードが存在
- 適切なステータスでコミュニティメンバーシップが確立
- ウォレットが作成され、正しく関連付けられている

### DIDリクエスト状態検証
- ステータスフィールドが適切な状態を反映（PROCESSING/PENDING）
- エラーメッセージが一貫性があり情報的
- 失敗に対してリトライカウントが適切に増加
- 成功したAPI呼び出しではジョブIDが入力され、失敗ではnull

### ノンブロッキング動作検証
- 外部APIの状態に関係なくメインユーザー作成フローが完了
- 外部API失敗がログに記録されるが例外をスローしない
- 外部失敗があってもデータベーストランザクションが正常に完了

## カバレッジ評価

### ✅ 十分にカバーされている領域
- **基本的な失敗シナリオ**: 外部API失敗の包括的カバレッジ
- **タイムアウト処理**: APIタイムアウトの適切なシミュレーションと処理
- **コアユーザーフロー保護**: 外部失敗にもかかわらずメインプロセスが継続
- **データベース状態管理**: リクエストステータス追跡の一貫したパターン
- **エラーメッセージ標準化**: 失敗タイプ全体での統一されたエラーハンドリング

### ⚠️ 特定されたギャップ
- **バッチ処理統合**: バッチDID処理シナリオのテストなし
- **同時ユーザー作成**: 同時ユーザー登録のテストが不足
- **長期リトライシナリオ**: テストは初期失敗のみをカバー、後続のリトライなし
- **複雑な認証フロー**: マルチステップ認証失敗の限定的テスト
- **持続的失敗下でのパフォーマンス**: 拡張外部サービス停止の負荷テストなし

## 実装ノート

### エラーハンドリング戦略
- 外部API失敗は例外をスローする代わりに`null`を返す
- 監視のために適切なレベル（warn/error）でエラーがログに記録
- データベースレコードがリトライ処理のために失敗状態を維持
- 外部サービスステータスに関係なくユーザー向け操作が正常に完了

### テストインフラストラクチャ
- 一貫したテストデータ管理のために`TestDataSourceHelper`を使用
- 適切なタイムアウトでの適切なasync/await処理
- テスト実行間の包括的クリーンアップ
- ターゲット化された外部APIモッキングでの実サービス統合

このテストスイートは、DID発行統合の包括的検証を維持しながら、外部サービス失敗に対してユーザー登録が堅牢であることを確保するための堅実な基盤を提供します。
