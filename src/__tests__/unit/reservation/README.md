# ✅ 単体テスト報告書｜ReservationService ユニットテスト

## 📌 対象モジュール

- **対象クラス**：`ReservationService`
- **依存モック**：
    - `ReservationConverter`（create / setStatus）
    - `ReservationRepository`（create / setStatus）
    - `getCurrentUserId`（ctx から userId 抽出）
- **テスト対象メソッド**：
    - `createReservation`
    - `setStatus`

---

## 🧪 テスト実施内容と結果

### 1. `createReservation`

| 項目 | 内容 |
|------|------|
| ケース数 | 3件（正常系／Converter失敗／Repository失敗） |
| 主な検証内容 | ConverterとRepositoryの呼び出し順・引数確認／例外発生時の挙動 |
| モック | `ReservationConverter.create`, `ReservationRepository.create` |
| テスト内容 | 複数人予約の作成処理。引数や状態の整合性とエラーハンドリングを含む。 |
| 結果 | ✅ 成功（正常系・例外系いずれも期待通りの動作を確認） |

---

### 2. `setStatus`

| 項目 | 内容 |
|------|------|
| ケース数 | 2件（正常系／Repository失敗） |
| 主な検証内容 | Converterによる更新データ生成と、それを用いた更新処理の検証 |
| モック | `ReservationConverter.setStatus`, `ReservationRepository.setStatus` |
| テスト内容 | Reservation に対して status を付与／変更する処理とエラー時の動作確認 |
| 結果 | ✅ 成功（ConverterとRepositoryの呼び出し、エラー処理含めて期待通り） |

---

## 🧪 品質チェックリスト

| 観点 | 評価 | コメント |
|------|------|----------|
| **テストカバレッジ** | ⭐️⭐️⭐️⭐️⭐️（高） | 正常パスと異常パス（Converter / Repository の throw）をすべて網羅している。 |
| **モック戦略** | ⭐️⭐️⭐️⭐️⭐️（良好） | `jest.mocked` + 事前の clearMocks により安定した検証が可能。 |
| **検証の粒度** | ⭐️⭐️⭐️⭐️⭐️（詳細） | Converter / Repository それぞれの引数・戻り値を細かく検証している。 |
| **責務の分離** | ⭐️⭐️⭐️⭐️⭐️（適切） | Converter: 入力整形, Repository: 永続化, Service: フロー制御 と明確に分離されている。 |
| **副作用の検証** | ⭐️⭐️⭐️⭐️（充分） | `create` / `setStatus` ともに副作用（永続化処理）の呼び出しが検証されている。 |

---

## ✅ 総合評価と改善点

### ✅ 評価

- **S（最高評価）**  
  少数精鋭ながら非常に密度の高いテストセット。異常系も含めて実運用に耐える堅牢なユニットテストが実装されている。

### 🛠 改善ポイント（任意）

- `createReservation` において **ユーザー数0のケース** や **参加人数と userIds の整合性** など、入力バリデーション的な観点も加えるとさらに安心。
- `setStatus` にて **更新後の状態チェック（例えば変更済みのフラグなど）** が入ると、より明確な完了確認となる。

---

# ✅ 単体テスト報告書｜ReservationValidator ユニットテスト

## 📌 対象モジュール

- **対象クラス**：`ReservationValidator`
- **依存モック**：なし（純粋関数ベース）
- **テスト対象メソッド**：
    - `validateReservable`
    - `validateJoinable`
    - `validateCancellable`

---

## 🧪 テスト実施内容と結果

### 1. `validateReservable`

| ケース数 | 6件（正常系: 2／異常系: 4） |
| テスト内容 |
- 残席数未定義の場合の正常系
- スロットがnullの防御
- 定員内での予約許可
- スロット未スケジュール → エラー
- 開始時刻が過去 → エラー
- 既存予約と競合 → エラー
- 定員オーバー → エラー
  | 結果 | ✅ 成功（バリデーションの全分岐を網羅） |

---

### 2. `validateJoinable`

| ケース数 | 5件（正常系: 1／異常系: 4） |
| テスト内容 |
- 未参加の空き参加枠がある場合に `availableParticipationId` を返す
- 予約が未承認（APPLIED） → エラー
- すでに参加済みのユーザー → エラー
- 全ての参加枠が埋まっている → エラー
- スロットの開始時刻が過去 → エラー
  | 結果 | ✅ 成功（参加判定ロジックと重複チェックの信頼性が高い） |

---

### 3. `validateCancellable`

| ケース数 | 2件（正常系: 1／異常系: 1） |
| テスト内容 |
- 開始時刻が24時間以上先 → 通過
- 開始時刻が24時間未満 → エラー
  | 結果 | ✅ 成功（時刻判定によるキャンセル可否のバリデーションが適切） |

---

## 🧪 品質チェックリスト

| 観点 | 評価 | コメント |
|------|------|----------|
| **テストカバレッジ** | ⭐️⭐️⭐️⭐️⭐️（非常に高い） | 各メソッドのあらゆる分岐が網羅されている。 |
| **検証の粒度** | ⭐️⭐️⭐️⭐️⭐️（詳細） | 戻り値・エラーメッセージ・例外型に至るまで明確にチェックされている。 |
| **責務の分離** | ⭐️⭐️⭐️⭐️⭐️（明確） | Validatorらしく「判定のみ」に責務が絞られており、実装とテストが一致している。 |
| **副作用の検証** | ⭐️⭐️⭐️⭐️⭐️（不要） | 純粋関数なので副作用なし。 |

---

## ✅ 総合評価と改善点

### ✅ 評価

- **S（最高評価）**  
  `ReservationValidator` の責務である「事前条件チェック」が、あらゆる分岐と例外パターンを通じて網羅的にテストされている。特に **スロット状態・時間判定・重複検知・定員超過** など、現実の制約を丁寧にモデル化している点が高評価。

### 🛠 改善ポイント（任意）

- `validateReservable` にて `startsAt` が不正な形式（Date以外）だった場合のハンドリングを明示するかは検討の余地あり。
- `validateJoinable` の `participations` 配列が `null` の場合を防御的にテストしても良い。

---
