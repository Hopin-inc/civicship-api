# 🧪 ユニットテスト報告書

## unit/account/community.service.test.ts（CommunityService）

### ✅ 成功系
- `createCommunityAndJoinAsOwner`
    - 入力に基づき Community を作成し、オーナーとして参加できる
- `updateCommunityProfile`
    - 既存 Community を正しく更新できる
- `deleteCommunity`
    - 既存 Community を正しく削除できる

### ❌ 失敗系
- `updateCommunityProfile`
    - 存在しない Community を更新しようとすると `NotFoundError`
- `deleteCommunity`
    - 存在しない Community を削除しようとすると `NotFoundError`

---

## unit/account/identity.service.test.ts（IdentityService）

### ✅ 成功系
- `createUserAndIdentity`
    - Identity を紐付けた User 作成に成功
- `deleteUserAndIdentity`
    - Identity が存在する場合 User を削除できる
- `deleteFirebaseAuthUser`
    - Firebase Auth ユーザーを削除できる

### ❌ 失敗系
- `createUserAndIdentity`
    - ユーザー作成失敗時にエラー発生
- `deleteUserAndIdentity`
    - User削除失敗時にエラー発生
    - Identityが存在しない場合、nullを返す
- `deleteFirebaseAuthUser`
    - Firebaseユーザー削除失敗時にエラー発生

---

## unit/account/membership.service.test.ts（MembershipService）

### ✅ 成功系
- `fetchMemberships`
    - Memberships を正しく一覧取得
- `findMembership`
    - Membership を ID 指定で取得
- `inviteMember`
    - 新規招待 Membership を作成
- `joinIfNeeded`
    - 存在しなければ Membership を新規作成
    - 既存があれば JOINEDに更新
- `setStatus`
    - ステータスを正しく更新
- `setRole`
    - ロールを MANAGER などに変更
- `deleteMembership`
    - Membership を削除

### ❌ 失敗系
- `setStatus`
    - 存在しない Membership を更新しようとすると `NotFoundError`
- `setRole`
    - 存在しない Membership を更新しようとすると `NotFoundError`
- `deleteMembership`
    - 存在しない場合に `NotFoundError`

---

## unit/account/user.service.test.ts（UserService）

### ✅ 成功系
- `findUser`
    - ユーザーを取得できる
- `fetchUsers`
    - ユーザー一覧をフィルター・ソート条件付きで取得
- `fetchCommunityMembers`
    - コミュニティメンバー一覧取得
- `updateProfile`
    - プロフィール更新が成功する

### ❌ 失敗系
- `findUser`
    - 存在しないユーザーIDの場合、nullを返す
- `updateProfile`
    - ユーザー存在なしで `NotFoundError`
    - 不正な入力（例：メール形式不正）で `ValidationError`
    - 権限不足で `AuthorizationError`

---

## unit/account/wallet.service.test.ts（WalletService）

### ✅ 成功系
- `fetchWallets`
    - Wallet 一覧取得
- `findWallet`
    - Wallet をID指定で取得
- `findMemberWalletOrThrow`
    - MemberWallet存在時に取得
- `findCommunityWalletOrThrow`
    - CommunityWallet存在時に取得
- `checkIfMemberWalletExists`
    - MemberWallet存在確認
- `createCommunityWallet`
    - 新規 CommunityWallet 作成
- `createMemberWalletIfNeeded`
    - MemberWallet存在チェックし、なければ作成
- `deleteMemberWallet`
    - MemberWallet削除成功

### ❌ 失敗系
- `findWallet`
    - 存在しない場合に null を返す
- `findMemberWalletOrThrow`
    - 存在しない場合に `NotFoundError`
- `findCommunityWalletOrThrow`
    - 存在しない場合に `NotFoundError`
- `checkIfMemberWalletExists`
    - 存在しない場合に `NotFoundError`
- `deleteMemberWallet`
    - MemberWalletが見つからなければ `NotFoundError`

---

## unit/account/wallet.validator.test.ts（WalletValidator）

### ✅ 成功系
- `validateCommunityMemberTransfer`
    - GRANT理由でウォレット間ポイント移動が正しく検証される
- `validateMemberToMemberDonation`
    - Member間ポイント寄付が成立する
- `validateTransfer`
    - 残高が十分な場合はエラーなく通過

### ❌ 失敗系
- `validateTransfer`
    - `fromWallet` または `toWallet` がnullだと `ValidationError`
    - 残高不足の場合 `InsufficientBalanceError`
    - `currentPointView` 欠損でも `InsufficientBalanceError`

---

## unit/experience/evaluation.service.test.ts（EvaluationService）

### ✅ 成功系
- `createEvaluation`
    - 正常なステータス（PASSED）で評価を作成できる
- `validateParticipationHasOpportunity`
    - Participation と Opportunity、Community ID、User ID の存在を検証できる

### ❌ 失敗系
- `createEvaluation`
    - 無効なステータス（例：PENDING）指定で `ValidationError`
- `validateParticipationHasOpportunity`
    - Participation が存在しない場合 `ValidationError`
    - Opportunity が存在しない場合 `ValidationError`
    - Community ID が存在しない場合 `ValidationError`

---

## unit/experience/opportunity.service.test.ts（OpportunityService）

### ✅ 成功系
- `createOpportunity`
    - Place 接続（whereのみ指定）で Opportunity を作成できる
    - 新規 Place 作成（create）でも Opportunity 作成可能
- `deleteOpportunity`
    - 存在する Opportunity を削除できる
- `updateOpportunityContent`
    - Content（タイトルや説明など）を更新できる
- `setOpportunityPublishStatus`
    - 公開ステータスを設定できる

### ❌ 失敗系
- `createOpportunity`
    - place に `where` と `create` の両方を含めると `ValidationError`
- `deleteOpportunity`
    - 存在しない Opportunity を削除しようとすると `NotFoundError`
- `updateOpportunityContent`
    - 無効な Place 入力で更新しようとすると `ValidationError`

---

## unit/experience/opportunitySlot.service.test.ts（OpportunitySlotService）

### ✅ 成功系
- `fetchOpportunitySlots`
    - Slot一覧をフィルター・ソート付きで取得
- `findOpportunitySlot`
    - ID指定で OpportunitySlot を取得
- `fetchAllSlotByOpportunityId`
    - Opportunity に紐づく Slot 一覧取得
- `bulkCreateOpportunitySlots`
    - Slot を一括作成できる
- `bulkUpdateOpportunitySlots`
    - Slot を一括更新できる（inputsあり）
- `bulkDeleteOpportunitySlots`
    - Slot を一括削除できる（idsあり）

### ❌ 失敗系
- `bulkUpdateOpportunitySlots`
    - 空配列入力時、Repository呼び出しせず正常終了
- `bulkDeleteOpportunitySlots`
    - 空配列入力時、Repository呼び出しせず正常終了

---

## unit/experience/participation.service.test.ts（ParticipationService）

### ✅ 成功系
- `createParticipation`
    - 個人記録用 Participation を作成できる
- `setStatus`
    - ステータス変更（例：NOT_PARTICIPATING）を実施できる
- `bulkSetStatusByReservation`
    - 予約に紐づく Participation をまとめてステータス変更
- `bulkCancelParticipationsByOpportunitySlot`
    - Slotキャンセルに伴い一括取消できる
- `validateDeletable`
    - 個人記録 (PEROSNAL_RECORD) の場合、削除可能と判定できる

### ❌ 失敗系
- `validateDeletable`
    - 個人記録でない場合 (例：RESERVATION_ACCEPTED)、削除不可 (`ValidationError`)

---

## unit/experience/reservation.service.test.ts（ReservationService）

### ✅ 成功系
- `createReservation`
    - 正常な入力で Reservation を作成できる
- `setStatus`
    - Reservation ステータスを変更できる

### ❌ 失敗系
- `createReservation`
    - Converter側でエラー発生時にスロー
    - Repository登録失敗時にスロー
- `setStatus`
    - Repository更新失敗時にスロー

---

## unit/experience/reservation.validator.test.ts（ReservationValidator）

### ✅ 成功系
- `validateReservable`
    - 正常なスロット・キャパシティで予約できる
- `validateJoinable`
    - 参加枠が空いている場合、参加できる
- `validateCancellable`
    - イベント24時間前ならキャンセル可能

### ❌ 失敗系
- `validateReservable`
    - スロットがキャンセルされている場合 `ValidationError`
    - スロットが開始済みの場合 `ValidationError`
    - 予約競合（すでに予約済み）で `ValidationError`
    - 定員オーバーで `ValidationError`
    - nullスロット受け取り時にエラー
- `validateJoinable`
    - Reservation未承認時に参加しようとすると `ValidationError`
    - すでに参加している場合にエラー
    - 参加可能な枠がない場合にエラー
    - 開始済みスロットに参加しようとするとエラー
- `validateCancellable`
    - イベント開始24時間未満の場合キャンセル不可 (`ValidationError`)

---

## unit/reward/ticket.service.test.ts（TicketService）

### ✅ 成功系
- `reserveManyTickets`
  - チケットを参加者ごとに予約できる
- `cancelReservedTicketsIfAvailable`
  - `DISABLED + RESERVED` 状態のチケットだけ予約取消できる
- `refundTickets`
  - 複数チケットを一括払い戻しできる
- `purchaseTicket`
  - チケットを新規購入できる
- `refundTicket`
  - 既存チケットを単体で払い戻しできる
- `useTicket`
  - チケットを使用済みにできる

### ❌ 失敗系
- `cancelReservedTicketsIfAvailable`
  - `AVAILABLE` 状態など、対象外チケットには何も行わない
- `refundTicket`
  - チケットが存在しない場合、内部でエラー検出（※findTicketOrThrowで拾う設計）

---

## unit/reward/ticketClaimLink.test.ts（TicketClaimLinkService）

### ✅ 成功系
- `validateBeforeClaim`
  - `ISSUED` 状態のクレームリンクを正常に返す
- `markAsClaimed`
  - クレームリンクを「CLAIMED」状態に更新できる

### ❌ 失敗系
- `validateBeforeClaim`
  - クレームリンクが存在しない場合 `NotFoundError`
  - `CLAIMED` もしくは `EXPIRED` 状態のリンクに対して `ValidationError`

---

## unit/reward/utility.service.test.ts（UtilityService）

### ✅ 成功系
- `findUtility`
  - フィルター条件付きで Utility を取得できる
- `findUtilityOrThrow`
  - Utility ID を指定して存在確認・取得できる
- `createUtility`
  - Utility を新規作成できる
- `deleteUtility`
  - Utility を削除できる（事前に存在確認）
- `updateUtilityInfo`
  - Utility の情報更新（名前・画像など）ができる
- `validatePublishStatus`
  - 許可された公開ステータス（例：PUBLIC）だけを許容する

### ❌ 失敗系
- `findUtilityOrThrow`
  - 指定IDに該当する Utility が存在しない場合 `NotFoundError`
- `validatePublishStatus`
  - 不正な公開ステータス（例：PRIVATE）指定時に `ValidationError`

---

# 🧪 ユニットテスト報告書（成功系・失敗系分類版・続き）

## unit/master.service.test.ts（MasterService）

### ✅ 成功系
- `checkIfCityExists`
  - City ID を指定して、存在確認できる（存在する場合は City オブジェクトを返す）

### ❌ 失敗系
- `checkIfCityExists`
  - City が存在しない場合 `NotFoundError` をスローする

---

## unit/transaction.service.test.ts（TransactionService）

### ✅ 成功系
- `issueCommunityPoint`
  - コミュニティポイント発行トランザクションを作成し、ポイント残高更新できる
- `grantCommunityPoint`
  - 管理者からメンバーへのポイント付与トランザクションを作成・残高更新できる
- `donateSelfPoint`
  - ユーザー間の自己寄付トランザクションを作成・残高更新できる
- `giveRewardPoint`
  - 参加に紐づく報酬ポイント付与トランザクションを作成・残高更新できる
- `purchaseTicket`
  - チケット購入時にポイント移動トランザクションを作成・残高更新できる

---
